<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservas - Usuario</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/shared.css}">
  <style>
    .main-container {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 24px;
      padding: 16px;
    }

    .room-card {
      display: flex;
      gap: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .room-card img {
      width: 220px;
      height: 160px;
      object-fit: cover;
      cursor: pointer;
    }

    .room-info {
      padding: 12px;
      flex: 1;
    }

    .tags {
      display: flex;
      gap: 8px;
      margin: 8px 0;
      flex-wrap: wrap;
    }

    .tag {
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
    }

    .price-reserve {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .payment-box {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      height: fit-content;
      position: sticky;
      top: 16px;
    }

    .payment-box .row {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
    }

    .section {
      border-top: 1px dashed #d1d5db;
      padding-top: 8px;
      margin-top: 8px;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 12px 0;
    }

    .filter-btn {
      width: 100%;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .8);
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 8px;
    }

    .user-info-badge {
      background: #f6f9fb;
      border: 1px solid #e2e8f0;
      padding: 8px 14px;
      border-radius: 8px;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 14px;
      margin-top: 10px;
    }

    .user-info-badge i {
      color: #64748b;
    }
  </style>
</head>

<body>
  <div th:replace="~{_layout::main-header}"></div>

  <div class="container mt-3">
    <h2>Reservar habitación</h2>
    <p class="text-muted">Completa los datos para registrar tu reserva.</p>
    <div class="user-info-badge">
      <i class="bi bi-person-circle"></i>
      <span
        th:if="${session.user instanceof T(com.springboot.sistema.hoteles.springboot_sistemahoteles.models.Usuario_Administracion)}"
        th:text="${session.user.nombres_apellidos}"></span>
      <span
        th:if="${session.user instanceof T(com.springboot.sistema.hoteles.springboot_sistemahoteles.models.UsuarioCliente)}"
        th:text="${session.user.nombres} + ' ' + ${session.user.apellidos}"></span>
    </div>
  </div>

  <div class="main-container">
    <div class="rooms">
      <div class="filters">
        <input type="datetime-local" id="checkin" class="form-control filter-btn">
        <input type="datetime-local" id="checkout" class="form-control filter-btn">
        <select id="guests" class="form-select filter-btn">
          <option value="1 adulto">1 Habitación - 1 Adulto</option>
          <option value="2 adultos">1 Habitación - 2 Adultos</option>
          <option value="2 adultos + 1 niño">1 Habitación - 2 Adultos + 1 Niño</option>
          <option value="4 adultos">1 Habitación - 4 Adultos</option>
        </select>
        <select id="roomtype" class="form-select filter-btn">
          <option value="">Tipo de habitación (todas)</option>
          <option value="Matrimonial">Matrimonial</option>
          <option value="Estandar">Suite Estandar</option>
          <option value="Doble">Doble</option>
          <option value="Doble Accesible">Doble Accesible</option>
          <option value="Familiar">Familiar</option>
        </select>
        <button class="btn btn-warning filter-btn" id="clearFilters" type="button">Limpiar</button>
      </div>

      <!-- Tarjetas -->
      <div th:each="h : ${habitaciones}" class="room-card" th:attr="data-type=${h.nombre_comercial}">
        <img th:src="@{'/api/reservas/habitaciones/' + ${h.id_habitacion} + '/foto'}" th:alt="${h.nombre_comercial}">
        <div class="room-info">
          <h5 th:text="${h.nombre_comercial}"></h5>
          <p th:text="${h.descripcion}"></p>
          <div class="tags">
            <span class="tag" th:text="${h.capacidad_total}"></span>
            <span class="tag" th:text="${h.medidas}"></span>
          </div>
          <div class="price-reserve">
            <p th:text="'Desde s/. ' + ${h.precio}"></p>
            <button class="btn btn-warning reserve-btn" th:attr="data-room=${h.nombre_comercial}, data-price=${h.precio}"
              type="button">Reservar</button>
          </div>
        </div>
      </div>

      <!-- Form -->
      <div class="card mt-3" id="booking-form" style="display: none;">
        <div class="card-header">Datos de la reserva</div>
        <div class="card-body">
          <form id="userBookingForm" class="row g-3" autocomplete="off">
            <div class="col-md-6">
              <label class="form-label">Nombres y Apellidos</label>
              <input type="text" class="form-control" id="nombresapellidos" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">DNI</label>
              <input type="text" class="form-control" id="dni" maxlength="8" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Edad</label>
              <input type="number" class="form-control" id="edad" min="0" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Habitación</label>
              <select class="form-select" id="habitacion" required>
                <option value="">--Elija una habitación--</option>
                <option th:each="h : ${habitaciones}" th:value="${h.nombre_comercial}" th:text="${h.nombre_comercial}"></option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ocupantes</label>
              <select class="form-select" id="ocupantes" required>
                <option value="">--ocupantes--</option>
                <option value="1 adulto">1 adulto</option>
                <option value="2 adultos">2 adultos</option>
                <option value="3 adultos">3 adultos</option>
                <option value="4 adultos">4 adultos</option>
                <option value="1 adulto + 1 niño">1 adulto + 1 niño</option>
                <option value="2 adultos + 1 niño">2 adultos + 1 niño</option>
                <option value="3 adultos + 1 niño">3 adultos + 1 niño</option>
                <option value="2 adultos + 3 niños">2 adultos + 3 niños</option>
                <option value="4 adultos + 2 niños">4 adultos + 2 niños</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Fecha de Inicio</label>
              <input type="datetime-local" class="form-control" id="fechaInicio" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Fecha de Salida</label>
              <input type="datetime-local" class="form-control" id="fecha_salida" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Método de pago</label>
              <select class="form-select" id="metodo_pago" required>
                <option value="">Seleccione su método de pago..</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Paypal">Paypal</option>
                <option value="Transferencia">Transferencia</option>
              </select>
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button type="button" class="btn btn-warning" id="btnReservar">Reservar</button>
            </div>
          </form>
        </div>
      </div>

    </div>

    <!-- Resumen -->
    <div class="payment-box">
      <h4>Resumen</h4>
      <div class="section">
        <small>Detalle de Reserva</small>
        <div class="row"><span>Habitación</span><span id="res_roomType">-</span></div>
        <div class="row"><span>Fechas</span><span id="res_dates">-</span></div>
        <div class="row"><span>Personas</span><span id="res_guests">-</span></div>
        <div class="row"><span>Días</span><span id="res_days">0</span></div>
      </div>
      <div class="section">
        <div class="row"><span>Precio x noche</span><span id="res_price">s/. 0</span></div>
      </div>
      <div class="section">
        <div class="row"><strong>Total</strong><strong id="res_total">s/. 0</strong></div>
      </div>
    </div>
  </div>

  <div th:replace="~{_layout::footer}"></div>

  <div class="modal" id="imgModal">
    <img id="modalImg" src="" alt="Vista ampliada">
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/reservas_usuario.js}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const reserveButtons = document.querySelectorAll('.reserve-btn');
      const bookingForm = document.getElementById('booking-form');
      const habitacionSelect = document.getElementById('habitacion');
      const btnReservar = document.getElementById('btnReservar');

      async function submitReservation() {
        const nombresapellidos = document.getElementById('nombresapellidos').value.trim();
        const dni = document.getElementById('dni').value.trim();
        const edad = Number(document.getElementById('edad').value);
        const habitacion = document.getElementById('habitacion').value;
        const ocupantes = document.getElementById('ocupantes').value;
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fecha_salida = document.getElementById('fecha_salida').value;
        const metodo_pago = document.getElementById('metodo_pago').value;

        if (!nombresapellidos) { alert('Ingrese nombres y apellidos'); return; }
        if (!dni || dni.length !== 8) { alert('DNI inválido. Debe tener 8 caracteres.'); return; }
        if (!Number.isFinite(edad) || edad < 18) { alert('No se permiten menores de 18 años.'); return; }
        if (!habitacion) { alert('Seleccione una habitación'); return; }
        if (!fechaInicio || !fecha_salida) { alert('Ingrese fechas de inicio y salida'); return; }
        if (!metodo_pago) { alert('Seleccione un método de pago'); return; }

        const reservaObj = {
          nombresapellidos, dni, edad, habitacion, ocupantes, fechaInicio, fecha_salida, metodo_pago
        };

        try {
          const resp = await fetch('/api/reserva', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reservaObj)
          });

          if (resp.status === 201) {
            const created = await resp.json();
            if (created && created.id_reserva) {
              window.location.href = '/proceso_pago?id=' + encodeURIComponent(created.id_reserva);
              return;
            }
            // fallback redirect if no id
            window.location.href = '/proceso_pago';
            return;
          }

          if (resp.status === 409) {
            const txt = await resp.text();
            alert('No disponible: ' + (txt || 'La habitación no está disponible en las fechas seleccionadas.'));
            return;
          }

          const txt = await resp.text();
          alert('Error al reservar: ' + (txt || resp.status));
        } catch (err) {
          console.error('Error al crear reserva', err);
          alert('Error al crear reserva. Revise la consola.');
        }
      }

      reserveButtons.forEach(button => {
        button.addEventListener('click', function () {
          const roomType = this.getAttribute('data-room');
          
          // Show the form
          bookingForm.style.display = 'block';

          // Set the selected room in the dropdown
          habitacionSelect.value = roomType;

          // Scroll to the form
          bookingForm.scrollIntoView({ behavior: 'smooth' });
        });
      });

      if (btnReservar) {
        btnReservar.addEventListener('click', function () {
          submitReservation();
        });
      }
    });
  </script>
</body>

</html>