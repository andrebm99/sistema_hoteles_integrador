<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{_navbar_admin}">

<head>
    <meta charset="UTF-8">
    <link rel="icon" th:href="@{/favicon.ico}">
    <title>UTP Integrador - Reservas</title>
</head>

<body>
    <section layout:fragment="content" id="app">

        <div class="container-fluid ">
            <h3 font-size-1>ADMINISTRAR RESERVAS DE HABITACIONES</h3>
            <section class="filtros mb-3">
            </section>
            <section class="tabla-reservas">
                <div class="container-fluid pt-3">
                    <form class="row gx-2 align-items-center p-2"
                        style="background: #f6f9fb; border-radius: 12px; align-items: center; display: flex; justify-content: center;">
                        <div class="col-auto">
                            <label class="form-label fw-semibold mb-1" for="codigo">Código</label>
                            <input type="text" class="form-control" id="codigo" style="max-width: 300px;"
                                v-model="filtros.codigo" placeholder="Código reserva">
                        </div>

                        <div class="col-auto">
                            <label class="form-label fw-semibold mb-1" for="nombresapellidos">Nombre</label>
                            <input type="text" class="form-control" id="nombresapellidos" style="max-width: 300px;"
                                v-model="filtros.nombresapellidos" placeholder="Nombre del huesped">
                        </div>

                        <div class="col-auto">
                            <label class="form-label fw-semibold mb-1" for="dni">DNI</label>
                            <input type="text" class="form-control" id="dni" style="max-width: 300px;"
                                v-model="filtros.dni" placeholder="DNI del huesped">
                        </div>

                        <div class="col-auto">
                            <label class="form-label fw-semibold mb-1" for="filter_habitacion">Habitaciones</label>
                            <select name="habitacion" id="filter_habitacion" class="form-select mb-1 col-sm-10"
                                v-model="filtros.habitacion" required>
                                <option value="">--Elija una habitación--</option>
                                <option value="Matrimonial">Matrimonial</option>
                                <option value="Estandar">Suite Estandar</option>
                                <option value="Doble">Doble</option>
                                <option value="Doble Accesible">Doble Accesible</option>
                                <option value="Familiar">Familiar</option>
                            </select>
                        </div>

                        <div class="col-auto d-flex align-items-end gap-1">

                            <button type="button" class="btn btn-outline-dark fw-semibold px-3"
                                @click="listar">Buscar</button>
                            <button type="button" class="btn btn-outline-dark fw-semibold px-3" @click="limpiar">Limpiar
                                filtro</button>
                            <button type="button" class="btn btn-outline-dark fw-semibold px-10" @click="nuevo">Agregar
                                +</button>

                        </div>
                    </form>
                </div>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Codigo</th>
                            <th>Nombres</th>
                            <th>DNI</th>
                            <th>Edad</th>
                            <th>Habitación</th>
                            <th>Ocupantes</th>
                            <th>Fecha de Inicio</th>
                            <th>Fecha de Salida</th>
                            <th>Precio(Noche)</th>
                            <th>Pago</th>
                            <th>Metodo de pago</th>
                            <th>Botones de Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in displayedReservas" :key="item.id_reserva">
                            <td>{{item.id_reserva}}</td>
                            <td>{{item.codigo}}</td>
                            <td>{{item.nombresapellidos}}</td>
                            <td>{{item.dni}}</td>
                            <td>{{item.edad}}</td>
                            <td>{{item.habitacion}}</td>
                            <td>{{item.ocupantes}}</td>
                            <td>{{item.fechaInicio}}</td>
                            <td>{{item.fecha_salida}}</td>
                            <td>{{item.precio_aplicado}}</td>
                            <td>{{item.total_aplicado}}</td>
                            <td>{{item.metodo_pago}}</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-sm btn-primary me-1"
                                        @click="editar(item.id_reserva)">Editar</button>
                                    <button class="btn btn-sm btn-danger me-1" @click="eliminar(item.id_reserva)"
                                        style="align-items: center; text-align: center; justify-content: center;">
                                        Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="d-flex align-items-center gap-2 my-2">
                    <button class="btn btn-sm btn-outline-primary" :disabled="page === 0"
                        @click="prevPage">Anterior</button>
                    <div class="mx-2">Página {{ page + 1 }} de {{ totalPages }}</div>
                    <button class="btn btn-sm btn-outline-primary" :disabled="page >= totalPages - 1"
                        @click="nextPage">Siguiente</button>

                    <div class="ms-3">
                        <button v-for="n in Math.min(totalPages, 7)" :key="n" class="btn btn-sm"
                            :class="{'btn-primary': (n-1) === page, 'btn-outline-secondary': (n-1) !== page}"
                            @click="goToPage(n-1)">
                            {{ n }}
                        </button>
                    </div>

                    <div class="ms-auto">Total: {{ totalElements }}</div>
                </div>
                <div class="modal" tabindex="-1" id="mdlEntidad">
                    <div class="modal-dialog">
                        <div class="modal-content" style="width: 700px;">
                            <div class="modal-header">
                                <h5 class="modal-title" v-if="entidad.id_reserva==null">Nuevo</h5>
                                <h5 class="modal-title" v-if="entidad.id_reserva!=null">Editar</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body row mb-3">
                                <div class="form-group row">
                                    <label for="nombresapellidos" class="col-sm-2 col-form-label">Nombres y
                                        Apellidos</label>
                                    <div class="col-sm-10">
                                        <input class="form-control" id="nombresapellidos"
                                            v-model="entidad.nombresapellidos" placeholder="Ingrese nombres y apellidos"
                                            required />
                                    </div>
                                </div>

                                <div class="form-group row mb-3">
                                    <label for="edad" class="col-sm-2 col-form-label">Ingrese su DNI</label>
                                    <div class="col-sm-10">
                                        <input class="form-control" id="dni" v-model="entidad.dni"
                                            placeholder="Ingrese su DNI" required />
                                    </div>
                                </div>

                                <div class="form-group row mb-3">
                                    <label for="dni" class="col-sm-2 col-form-label">Ingrese su Edad</label>
                                    <div class="col-sm-10">
                                        <input class="form-control" id="edad" v-model="entidad.edad"
                                            placeholder="Ingrese su Edad" required />
                                    </div>
                                </div>

                                <div class="form-group row mb-3">
                                    <p class="col-sm-2 col-form-label">
                                        Habitacion:
                                    <div class="col-sm-10">
                                        <select name="habitacion" id="habitacion" class="form-select mb-3 col-sm-10"
                                            v-model="entidad.habitacion" required>
                                            <option value="">--Elija una habitación--</option>
                                            <option value="Matrimonial">Matrimonial</option>
                                            <option value="Estandar">Suite Estandar</option>
                                            <option value="Doble">Doble</option>
                                            <option value="Doble Accesible">Doble Accesible</option>
                                            <option value="Familiar">Familiar</option>
                                        </select>
                                    </div>
                                    </p>
                                </div>
                                <div class="form-group row mb-3">
                                    <p class="col-sm-2 col-form-label">
                                        Cantidad de ocupantes:
                                    <div class="col-sm-10">
                                        <select name="ocupantes" id="piso" class="form-select mb-3"
                                            v-model="entidad.ocupantes" required>
                                            <option value="">--ocupantes--</option>
                                            <option value="1 adulto">1 adulto</option>
                                            <option value="2 adultos">2 adultos</option>
                                            <option value="3 adultos">3 adultos</option>
                                            <option value="4 adultos">4 adultos</option>
                                            <option value="1 adulto + 1 niño">1 adulto + 1 niño</option>
                                            <option value="2 adultos + 1 niño">2 adultos + 1 niño</option>
                                            <option value="3 adultos + 1 niño">3 adultos + 1 niño</option>
                                            <option value="2 adultos + 3 niños">2 adultos + 3 niños</option>
                                            <option value="4 adultos + 2 niños">4 adultos + 2 niños</option>
                                        </select>
                                    </div>
                                    </p>
                                </div>
                                <div class="form-group row mb-3">
                                    <label for="fechaInicio" class="col-sm-2 col-form-label">Fecha de Inicio</label>
                                    <div class="col-sm-10">
                                        <input type="datetime-local" class="form-control" id="fechaInicio"
                                            v-model="entidad.fechaInicio" required />
                                    </div>
                                </div>
                                <div class="form-group row mb-3">
                                    <label for="fecha_salida" class="col-sm-2 col-form-label">Fecha de Salida</label>
                                    <div class="col-sm-10">
                                        <input type="datetime-local" class="form-control" id="fecha_salida"
                                            v-model="entidad.fecha_salida" />
                                    </div>
                                </div>
                                <div class="form-group row mb-3">
                                    <p class="col-sm-2 col-form-label">
                                        Método de pago:
                                    <div class="col-sm-10">
                                        <select name="metodo_pago" id="metodo_pago" class="form-select mb-3 col-sm-10"
                                            required v-model="entidad.metodo_pago">
                                            <option value="">Seleccione su método de pago..</option>
                                            <option value="Tarjeta">Tarjeta</option>
                                            <option value="Paypal">Paypal</option>
                                            <option value="Transferencia">Transferencia</option>
                                        </select>
                                    </div>
                                    </p>
                                </div>
                                
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" v-if="entidad.id_reserva==null"
                                    @click="guardar">Reservar</button>
                                <button type="button" class="btn btn-primary" v-if="entidad.id_reserva!=null"
                                    @click="actualizar">Actualizar</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal" tabindex="-1" id="mdlEliminar">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Eliminar</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ¿Estás seguro que quieres eliminar?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger"
                                    @click="confirmareliminacion">Eliminar</button>
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </section>

    <script layout:fragment="script">
        new Vue({
            el: "#app",
            data: {
                filtros: {
                    codigo: '',
                    nombresapellidos: '',
                    dni: '',
                    habitacion: ''
                },
                entidad: {
                    id_reserva: null,
                    nombresapellidos: '',
                    dni: '',
                    edad: '',
                    habitacion: '',
                    ocupantes: '',
                    fechaInicio: '',
                    fecha_salida: '',
                    precio_aplicado: '',
                    total_aplicado: '',
                    metodo_pago: ''
                },
                entidades: [],
                allReservas: [],
                displayedReservas: [],
                page: 0,
                size: 10,
                totalPages: 0,
                totalElements: 0,
                sortBy: 'id_reserva',
                sortDir: 'asc'
            },
            methods: {

                showModal: function (id) {
                    const el = document.getElementById(id);
                    if (!el) return;

                    const modal = bootstrap.Modal.getOrCreateInstance(el);
                    modal.show();
                },
                hideModal: function (id) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const modal = bootstrap.Modal.getOrCreateInstance(el);
                    modal.hide();
                },
                responseArray(response) {
                    const data = (response && response.data !== undefined)
                        ? response.data
                        : (response && response.body !== undefined
                            ? response.body : null
                        );
                    if (!data) return [];

                    if (data.content !== undefined && Array.isArray(data.content)) {
                        return data.content;
                    }

                    if (Array.isArray(data)) {
                        return data;
                    }
                    return [data];
                },
                updateDisplayed() {
                    const start = this.page * this.size;
                    const end = start + this.size;
                    this.displayedReservas = (this.allReservas || []).slice(start, end)
                },
                prevPage() {
                    if (this.page > 0) {
                        this.page = this.page - 1;
                        this.listar();
                    }
                },

                nextPage() {
                    if (this.page < this.totalPages - 1) {
                        this.page = this.page + 1;
                        this.listar();
                    }
                },
                goToPage(n) {
                    if (n >= 0 && n < this.totalPages) {
                        this.page = n;
                        this.listar();
                    }
                },

                listar: function () {
                    const params = new URLSearchParams();
                    params.append('page', this.page);
                    params.append('size', this.size);
                    params.append('sortBy', this.sortBy);
                    params.append('sortDir', this.sortDir);

                    const codigo = this.filtros.codigo && this.filtros.codigo.trim() !== "" ? this.filtros.codigo.trim() : null;
                    const nombresapellidos = this.filtros.nombresapellidos && this.filtros.nombresapellidos.trim() !== "" ? this.filtros.nombresapellidos.trim() : null;
                    const dni = this.filtros.dni && this.filtros.dni.trim() !== "" ? this.filtros.dni.trim() : null;
                    const habitacion = this.filtros.habitacion && this.filtros.habitacion.trim() !== "" ? this.filtros.habitacion.trim() : null;

                    if (codigo) params.append('codigo', codigo);
                    if (nombresapellidos) params.append('nombresapellidos', nombresapellidos);
                    if (dni) params.append('dni', dni);
                    if (habitacion) params.append('habitacion', habitacion);

                    (this.$http || axios).get('/api/reserva?' + params.toString())
                        .then(response => {
                            const resp = (response && response.data) ? response.data : null;
                            const content = resp && Array.isArray(resp.content) ? resp.content : [];
                            this.entidades = content;
                            this.displayedReservas = content; // servidor ya trajo la página correcta
                            this.allReservas = content;
                            this.totalElements = resp && resp.totalElements !== undefined ? resp.totalElements : content.length;
                            this.totalPages = resp && resp.totalPages !== undefined ? resp.totalPages : Math.max(1, Math.ceil(this.totalElements / this.size));
                            this.page = resp && resp.page !== undefined ? resp.page : 0;
                            this.size = resp && resp.size !== undefined ? resp.size : this.size;
                        })
                        .catch(error => {
                            console.error('Error al listar reservas', error);
                            this.allReservas = [];
                            this.displayedReservas = [];
                            this.totalPages = 0;
                            this.totalElements = 0;
                        });
                },
                toLocalDateTimeString: function (date) {
                    return new Date(date).toISOString().slice(0, 19);
                },

                checkDisponibilidad: async function (habitacion, inicioDate, finDate) {
                    const inicio = this.toLocalDateTimeString(inicioDate);
                    const fin = this.toLocalDateTimeString(finDate);
                    const url = '/api/reserva/disponibilidad'
                        + '?habitacion=' + encodeURIComponent(habitacion)
                        + '&fechaInicio=' + encodeURIComponent(inicio)
                        + '&fechaFin=' + encodeURIComponent(fin);
                    const resp = await fetch(url);
                    if (!resp.ok) {
                        const txt = await resp.text();
                        throw new Error(`Error comprobando disponibilidad: ${resp.status} ${txt}`);
                    }

                    const json = await resp.json();
                    return json.disponible === true;
                },

                reservar: async function (habitacion, inicioDate, finDate, datosReserva) {
                    const ok = await this.checkDisponibilidad(habitacion, inicioDate, finDate);

                    if (!ok) {
                        alert("La habitación no está disponible en esas fechas");
                        return;
                    }
                },

                crearReservaAPI: async function (reservaObj) {
                    const resp = await fetch('/api/reserva', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(reservaObj)
                    });
                    if (resp.status === 201) {
                        const created = await resp.json();
                        return {
                            ok: true,
                            data: created
                        };
                    }
                    if (resp.status === 409) {
                        const txt = await resp.text();
                        return {
                            ok: false,
                            code: 409,
                            message: txt || "Habitación no disponible."
                        };
                    }

                    if (resp.status === 400) {
                        const txt = await resp.text();
                        return {
                            ok: false,
                            code: 400,
                            message: txt || "Datos inválidos"
                        };
                    }

                    const txt = await resp.text();
                    return {
                        ok: false,
                        code: resp.status,
                        message: txt || "Error del servidor."
                    };
                },

                nuevo: function () {
                    this.entidad = {
                        id_reserva: null,
                        nombresapellidos: "",
                        dni: null,
                        edad: null,
                        habitacion: "",
                        ocupantes: "",
                        fechaInicio: "",
                        fecha_salida: "",
                        metodo_pago: ""

                    };
                    $("#mdlEntidad").modal("show");
                },
                editar: function (id_reserva) {
                    (this.$http || axios).get('/api/reserva/' + id_reserva).then(response => {
                        this.entidad = response.data;
                        $("#mdlEntidad").modal("show");
                    });
                },
                guardar: function () {
                    const dni = String(this.entidad.dni);
                    if (!dni || dni.length !== 8) { alert("Esta ingresando menos/más caracteres que lo permitido."); return; }
                    const edad = Number(this.entidad.edad);
                    if (!Number.isFinite(edad) || edad < 18) { alert("No se permiten menores de 18 en registros del Hotel Aurum!."); return; }

                    (this.$http || axios).post('/api/reserva', this.entidad)
                        .then(response => {
                            const created = response.data;
                            this.listar();
                            $("#mdlEntidad").modal("hide");
                            if (created && created.id_reserva) {
                                window.location.href = '/proceso_pago?id=' + encodeURIComponent(created.id_reserva);
                            } else {
                                alert('Reserva creada, pero no se pudo redirigir al pago.');
                            }
                        })
                        .catch(error => {
                            const status = error.status || (error.response && error.response.status);
                            const body = error.body || (error.response && error.response.data) || '';
                            if (status === 409) {
                                alert("No disponible: " + (body || "La habitación no está disponible en las fechas indicasdas."));
                            } else if (status === 404) {
                                alert("Habitación no encontrada: " + (body || "Revise la habitación seleccionada"));
                            } else {
                                console.error(error);
                                alert("Error al guardar reserva.");
                            }
                        });
                },
                actualizar: function () {
                    (this.$http || axios).put('/api/reserva/' + this.entidad.id_reserva, this.entidad).then(response => {
                        this.listar();
                        $("#mdlEntidad").modal("hide");
                    }).catch(error => {
                        console.error('Error al actualizar reserva', error);
                        alert('Error al actualizar reserva.');
                    });
                },
                eliminar: function (id_reserva) {
                    this.entidad.id_reserva = id_reserva;
                    $("#mdlEliminar").modal("show");
                },
                confirmareliminacion: function () {
                    (this.$http || axios).delete('/api/reserva/' + this.entidad.id_reserva).then(response => {
                        this.listar();
                        $("#mdlEliminar").modal("hide");
                    }).catch(error => {
                        console.error('Error al eliminar reserva', error);
                        alert('Error al eliminar reserva.');
                    });
                },

                estadoInicial() {
                    return {
                        codigo: '',
                        nombresapellidos: '',
                        dni: '',
                        habitacion: ''
                    };
                },
                limpiar() {
                    this.filtros = this.estadoInicial();
                    this.listar();
                }

            },
            mounted: function () {
                this.listar();
            }
        });
    </script>
</body>

</html>