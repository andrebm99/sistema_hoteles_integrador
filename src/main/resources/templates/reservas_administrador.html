<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{_navbar_admin}">

<head>
    <meta charset="UTF-8">
    <link rel="icon" th:href="@{/favicon.ico}">
    <title>UTP Integrador - Reservas</title>
</head>

<body>
    <section layout:fragment="content" id="app">

        <div class="container-fluid ">
            <h3 font-size-1>ADMINISTRAR RESERVAS DE HABITACIONES</h3>
            <section class="filtros mb-3">
            </section>
            <section class="tabla-reservas">
                <div class="container-fluid pt-3">
                    <form class="row gx-2 align-items-center p-2"
                        style="background: #f6f9fb; border-radius: 12px; align-items: center; display: flex; justify-content: center;">
                        <div class="col-auto">
                            <label class="form-label fw-semibold mb-1" for="codigo">Código</label>
                            <input type="text" class="form-control" id="codigo" style="max-width: 300px;"
                                v-model="filtros.codigo" placeholder="Código reserva">
                        </div>

                        <div class="col-auto">
                            <label class="form-label fw-semibold mb-1" for="nombre">Nombre</label>
                            <input type="text" class="form-control" id="nombre" style="max-width: 300px;"
                                v-model="filtros.nombresapellidos" placeholder="Nombre del huesped">
                        </div>

                        <div class="col-auto">
                            <label class="form-label fw-semibold mb-1" for="dni">DNI</label>
                            <input type="text" class="form-control" id="dni" style="max-width: 300px;"
                                v-model="filtros.dni" placeholder="DNI del huesped">
                        </div>

                        <div class="col-auto">
                            <label class="form-label fw-semibold mb-1" for="habitacion">Habitaciones</label>
                                <select name="habitacion" id="habitacion" class="form-select mb-1 col-sm-10"
                                    v-model="entidad.habitacion" required>
                                    <option value="">--Elija una habitación--</option>
                                    <option value="Matrimonial">Matrimonial</option>
                                    <option value="Estandar">Suite Estandar</option>
                                    <option value="Doble">Doble</option>
                                    <option value="Doble Accesible">Doble Accesible</option>
                                    <option value="Familiar">Familiar</option>
                                </select>
                        </div>

                        <div class="col-auto d-flex align-items-end gap-1">

                            <button type="button" class="btn btn-outline-dark fw-semibold px-3"
                                @click="listar">Buscar</button>
                            <button type="button" class="btn btn-outline-dark fw-semibold px-3"
                                @click="limpiar">Limpiar filtro</button>
                            <button type="button" class="btn btn-outline-dark fw-semibold px-10" @click="nuevo">Agregar
                                +</button>

                        </div>
                    </form>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Codigo</th>
                            <th>Nombres</th>
                            <th>DNI</th>
                            <th>Edad</th>
                            <th>Habitación</th>
                            <th>Ocupantes</th>
                            <th>Fecha de Inicio</th>
                            <th>Fecha de Salida</th>
                            <th>Metodo de pago</th>
                            <th>Botones de Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in entidades" :key="item.id_reserva">
                            <td>{{item.id_reserva}}</td>
                            <td>{{item.codigo}}</td>
                            <td>{{item.nombresapellidos}}</td>
                            <td>{{item.dni}}</td>
                            <td>{{item.edad}}</td>
                            <td>{{item.habitacion}}</td>
                            <td>{{item.ocupantes}}</td>
                            <td>{{item.fechaInicio}}</td>
                            <td>{{item.fecha_salida}}</td>
                            <td>{{item.metodo_pago}}</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-primary me-1"
                                        @click="editar(item.id_reserva)">Editar</button>
                                    <button class="btn btn-danger me-1" @click="eliminar(item.id_reserva)"
                                        style="align-items: center; text-align: center; justify-content: center;">
                                        Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="modal" tabindex="-1" id="mdlEntidad">
                    <div class="modal-dialog">
                        <div class="modal-content" style="width: 700px;">
                            <div class="modal-header">
                                <h5 class="modal-title" v-if="entidad.id_reserva==0">Nuevo</h5>
                                <h5 class="modal-title" v-if="entidad.id_reserva!=0">Editar</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body row mb-3">
                                <div class="form-group row">
                                    <label for="nombresapellidos" class="col-sm-2 col-form-label">Nombres y
                                        Apellidos</label>
                                    <div class="col-sm-10">
                                        <input class="form-control" id="nombresapellidos"
                                            v-model="entidad.nombresapellidos" placeholder="Ingrese nombres y apellidos"
                                            required />
                                    </div>
                                </div>
                                
                                <div class="form-group row mb-3">
                                    <label for="edad" class="col-sm-2 col-form-label">Ingrese su DNI</label>
                                    <div class="col-sm-10">
                                        <input class="form-control" id="dni" v-model="entidad.dni"
                                            placeholder="Ingrese su DNI" required />
                                    </div>
                                </div>
                                
                                <div class="form-group row mb-3">
                                    <label for="dni" class="col-sm-2 col-form-label">Ingrese su Edad</label>
                                    <div class="col-sm-10">
                                        <input class="form-control" id="edad" v-model="entidad.edad"
                                            placeholder="Ingrese su Edad" required />
                                    </div>
                                </div>

                                <div class="form-group row mb-3">
                                    <p class="col-sm-2 col-form-label">
                                        Habitacion:
                                    <div class="col-sm-10">
                                        <select name="habitacion" id="habitacion" class="form-select mb-3 col-sm-10"
                                            v-model="entidad.habitacion" required>
                                            <option value="">--Elija una habitación--</option>
                                            <option value="Matrimonial">Matrimonial</option>
                                            <option value="Estandar">Suite Estandar</option>
                                            <option value="Doble">Doble</option>
                                            <option value="Doble Accesible">Doble Accesible</option>
                                            <option value="Familiar">Familiar</option>
                                        </select>
                                    </div>
                                    </p>
                                </div>
                                <div class="form-group row mb-3">
                                    <p class="col-sm-2 col-form-label">
                                        Cantidad de ocupantes:
                                    <div class="col-sm-10">
                                        <select name="ocupantes" id="piso" class="form-select mb-3"
                                            v-model="entidad.ocupantes" required>
                                            <option value="">--ocupantes--</option>
                                            <option valu="1 adulto">1 adulto</option>
                                            <option value="2 adultos">2 adultos</option>
                                            <option value="3 adultos">3 adultos</option>
                                            <option value="4 adultos">4 adultos</option>
                                            <option value="1 adulto + 1 niño">1 adulto + 1 niño</option>
                                            <option value="2 adultos + 1 niño">2 adultos + 1 niño</option>
                                            <option value="3 adultos + 1 niño">3 adultos + 1 niño</option>
                                            <option value="2 adultos + 3 niños">2 adultos + 3 niños</option>
                                            <option value="4 adultos + 2 niños">4 adultos + 2 niños</option>
                                        </select>
                                    </div>
                                    </p>
                                </div>
                                <div class="form-group row mb-3">
                                    <label for="fechaInicio" class="col-sm-2 col-form-label">Fecha de Inicio</label>
                                    <div class="col-sm-10">
                                        <input type="datetime-local" class="form-control" id="fechaInicio"
                                            v-model="entidad.fechaInicio" required />
                                    </div>
                                </div>
                                <div class="form-group row mb-3">
                                    <label for="fecha_salida" class="col-sm-2 col-form-label">Fecha de Salida</label>
                                    <div class="col-sm-10">
                                        <input type="datetime-local" class="form-control" id="fecha_salida"
                                            v-model="entidad.fecha_salida" />
                                    </div>
                                </div>
                                <div class="form-group row mb-3">
                                    <p class="col-sm-2 col-form-label">
                                        Método de pago:
                                    <div class="col-sm-10">
                                        <select name="metodo_pago" id="metodo_pago" class="form-select mb-3 col-sm-10"
                                            required v-model="entidad.metodo_pago">
                                            <option value="">Seleccione su método de pago..</option>
                                            <option value="Tarjeta">Tarjeta</option>
                                            <option value="Paypal">Paypal</option>
                                            <option value="Transferencia">Transferencia</option>
                                        </select>
                                    </div>
                                    </p>
                                </div>
                                <div class="form-group row mb-3 align-items-center">
                                    <label for="proceso_pago" class="col-sm-4 col-form-label">Ir al proceso de pago: </label>
                                    <div class="col-sm-8 justify-content-end">
                                        <a class="btn btn-primary" th:href="@{/proceso_pago}">Pagar ahora</a>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" v-if="entidad.id_reserva==0"
                                    @click="guardar">Reservar</button>
                                <button type="button" class="btn btn-primary" v-if="entidad.id_reserva!=0"
                                    @click="actualizar">Actualizar</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal" tabindex="-1" id="mdlEliminar">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Eliminar</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ¿Estás seguro que quieres eliminar?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger"
                                    @click="confirmareliminacion">Eliminar</button>
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </section>

    <script layout:fragment="script">
        new Vue({
            el: "#app",
            data: {
                filtros: {
                    codigo: '',
                    // nombresapellidos: '',
                    // dni: ''

                },
                entidad: {
                    nombresapellidos: '',
                    dni: '',
                    edad: '',
                    habitacion: '',
                    ocupantes: '',
                    fechaInicio: '',
                    fecha_salida: '',
                    metodo_pago: ''
                },
                entidades: []
            },
            methods: {

                showModal: function (id) {
                    const el = document.getElementById(id);
                    if (!el) return;

                    const modal = bootstrap.Modal.getOrCreateInstance(el);
                    modal.show();
                },
                hideModal: function (id) {
                    const el = document.getElementById(el);
                    if (!el) return;
                    const modal = bootstrap.Modal.getOrCreateInstance(el);
                    modal.hide();
                },
                listar: function () {
                    const codigo = this.filtros.codigo && this.filtros.codigo.trim() !== "" ?
                        this.filtros.codigo.trim() : null;
                    if (codigo) {
                        this.$http.get('/api/reserva/codigo/' + encodeURIComponent(codigo))
                            .then(response => {
                                const data = (
                                    response && response.data !== undefined)
                                    ? response.data : (response && response.body !== undefined
                                        ? response.body : null);
                                this.entidades = data ? [data] : [];
                            })
                            .catch(error => {
                                this.entidades = [];
                                alert('No encontrado o error al buscar por código', error);
                            });
                        return;
                    }

                    this.$http.get('/api/reserva')
                        .then(response => {
                            const data = (
                                response && response.data !== undefined)
                                ? response.data : (response && response.body !== undefined
                                    ? response.body : []);
                            this.entidades = Array.isArray(data) ? data : [];
                        })
                        .catch(error => {
                            console.error('Error al listar reservas', error);
                            this.entidades = [];
                        });

                },

                nuevo: function () {
                    this.entidad = {
                        id_reserva: 0,
                        nombresapellidos: "",
                        dni: null,
                        edad: null,
                        habitacion: "",
                        ocupantes: "",
                        fechaInicio: "",
                        fecha_salida: "",
                        metodo_pago: ""

                    };
                    $("#mdlEntidad").modal("show");
                },
                editar: function (id_reserva) {
                    this.$http.get('/api/reserva/' + id_reserva).then(response => {
                        this.entidad = response.data;
                        $("#mdlEntidad").modal("show");
                    });
                },
                guardar: function () {
                    const dni = String(this.entidad.dni);

                    if (!dni || dni.length !== 8) {
                        alert("Esta ingresando menos/más caracteres que lo permitido.");
                        return;
                    }

                    const edad = Number(this.entidad.edad);

                    if(!Number.isFinite(edad) || edad < 18){
                        alert("No se permiten menores de 18 en registros del Hotel Aurum!."); 
                        return;
                    }

                    this.$http.post('/api/reserva', this.entidad).then(response => {
                        this.listar();
                        $("#mdlEntidad").modal("hide");
                    });
                },
                actualizar: function () {
                    this.$http.put('/api/reserva/' + this.entidad.id_reserva, this.entidad).then(response => {
                        this.listar();
                        $("#mdlEntidad").modal("hide");
                    });
                },
                eliminar: function (id_reserva) {
                    this.entidad.id_reserva = id_reserva;
                    $("#mdlEliminar").modal("show");
                },
                confirmareliminacion: function () {
                    this.$http.delete('/api/reserva/' + this.entidad.id_reserva).then(response => {
                        this.listar();
                        $("#mdlEliminar").modal("hide");
                    });
                },

                estadoInicial() {
                    return {
                        codigo: ''
                    };
                },
                limpiar() {
                    this.filtros = this.estadoInicial();
                }

            },
            mounted: function () {
                this.listar();
            }
        });
    </script>
</body>

</html>